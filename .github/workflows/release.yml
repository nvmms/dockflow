name: Build and Release .deb package

on:
  push:
    tags:
      - 'v*'  # 监听版本号标签（如 v1.0.0），触发发布
  workflow_dispatch:  # 手动触发
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true

permissions:
  contents: write
  
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 检出代码
      - name: Checkout repository
        uses: actions/checkout@v2

      # 设置 Go 环境
      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: '1.25'

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
            echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          fi

      # 安装构建依赖（例如 fpm）
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby-dev
          sudo gem install --no-document fpm

      # 构建 Go 项目
      - name: Build Go binary
        run: |
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build \
            -ldflags="-X main.Version=${{ steps.version.outputs.VERSION }}" \
            -o ./pkg/usr/bin/dockflow \
            ./cmd/dockflow

      # 创建 .deb 包
      - name: Build .deb package
        run: |
          fpm -s dir -t deb \
            -n dockflow \
            -v "${{ steps.version.outputs.VERSION }}" \
            --architecture amd64 \
            --deb-priority optional \
            --deb-compression xz \
            --deb-user root \
            --deb-group root \
            --after-install debian/postinst \
            -C pkg \
            usr etc

      # 上传 .deb 包到 GitHub Release
      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dockflow_${{ steps.version.outputs.VERSION }}_amd64.deb
          prerelease: false

